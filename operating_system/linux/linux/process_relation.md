## 进程关系

2021-12-11

---

### 代码和文件

- demo_c/demo_linux_c/daemon/daemon.c

### 伪终端

下面是`ps -l`命令的结果：

```
F S   UID   PID  PPID  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD
4 S     0    31     0  0  80   0 -  2961 -      pts/2    00:00:00 bash
0 R     0   301    31  0  80   0 - 12406 -      pts/2    00:00:00 ps
```

进程（PID）31，是由bash（`/bin/bash`）文件启动的，同时该进程关联的标准输入设备（TTY）是一个伪终端`pts/2`。所以，进程31是关联了终端的进程，也称为控制进程。

### 进程组

进程组就是多个进程的集合，每个进程它都有所属的进程组，每个进程组都有一个组长。进程有自己的标识，称为进程id，进程组也有自己的标识，称为进程组id。

程序中，通过`getpgid()`函数或者`getpgrp()`函数获取指定进程id所属的进程组的id，通过`setpgid()`函数设置指定进程id所属的进程组。

### 会话

会话就是进程组的集合，每个会话都有会话id。

程序中，通过`getsid()`函数获取会话id，通过`setsid()`函数设置会话。当一个进程调用`setsid()`函数时，会发生三件事：

- 该进程会变成会话首进程（session leader）。
- 该进程会变成进程组的组长。
- 该进程不会关联终端，就算父进程有终端也会断开（后面可以再关联终端）。

一个会话可能关联一个终端，如果一个会话首进程关联了终端，此时它就是控制进程。

一个会话关联了一个终端后，它至少有一个前台进程组，其它都是后台进程组。在终端输入特殊字符，如：中断键（ctrl+c）、暂停键（ctrl+z）、退出键（ctrl+\）。会产生中断信号，并往前台进程组里的所有进程发送，但是不会给后台进程组里的进程发送。

### 作业控制

作业控制就是在shell控制终端启动多个作业（子进程）。

### 守护进程

守护进程最基本的特点就是不带终端，并且运行在后台。

这里的运行在后台和上文的后台进程组是有区别的，上文的后台进程组，进程依然是和会话关联的。而守护进程的父进程是1号进程，和启动它的会话进程不关联。

#### 编写守护进程的步骤

- `umask()`函数。
- 创建一个子进程，父进程退出。因为调用setsid函数的进程不能是组长进程。
- 子进程调用`setsid()`函数，创建一个新的会话。调用进程调用`setsid()`函数时，该调用进程会变成会话首进程，变成进程组的组长，不关联终端。
- 有些时候在调用完`setsid()`时，还会再创建一个子进程，并关闭父进程（会话首进程）。
- 修改进程的工作目录，一般为根目录。
- 关闭不必要的文件描述符（0、1、2），打开黑洞文件（`/dev/null`），彻底的断开控制终端。

代码详见`demo_c/demo_linux_c/daemon/daemon.c`。

程序运行之后会变成守护进程，不会在终端有输出。可以通过`ps -ely`查看进程状态。

```
ps -ely
S   UID   PID  PPID  C PRI  NI   RSS    SZ WCHAN  TTY          TIME CMD
S     0     1     0  0  80   0  2824  2961 -      pts/0    00:00:00 bash
S     0    16     0  0  80   0  3064  2961 -      pts/1    00:00:00 bash
S     0    45     1  0  80   0    88  1058 -      ?        00:00:00 daemon
S     0    46    45  0  80   0    88  1058 -      ?        00:00:00 daemon
R     0    50    16  0  80   0  3076 12406 -      pts/1    00:00:00 ps
```

可以看到进程（PID）45运行的daemon程序，它的父进程变成1号进程了，这时进程45它就是一个守护进程。从进程关联的标准输入设备（TTY）也可以看到进程45它值是`?`，表示没有连接终端。

另外也可以通过`daemon()`函数创建守护进程。详见linux文档`daemon(3)`。