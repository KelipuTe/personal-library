## 进程内存

- 2021-12-07

进程通过系统函数execve将可执行文件的`.text`（程序指令）和`.data`（程序数据）加载到内存中去执行，此时操作系统会它分配相应的内存资源。

### 代码和文件

- demo_c/demo/hello/hello

### linux进程内存布局

- 内核空间（kernel space）
- 栈（stack）
- 动态库的映射
- 堆（heap）
- 读写数据区，主要是程序数据，`.data`、`.bss` 等
- 只读数据区，主要是程序指令，`.text`、`.init`、`.rodata` 等
- 保留区

### 动态库

动态库又称为共享库，按elf格式存储，存储的内容主要是程序指令和程序数据。

动态库的使用方式：引入头文件（声明和定义）；加载这个库文件（静态库，动态库，共享库）。

可以通过ldd命令列出一个程序所需要得动态链接库。

```
ldd hello
```

```
linux-vdso.so.1 =>  (0x00007ffeb1fcb000)
libc.so.6 => /lib64/libc.so.6 (0x00007f3a77af6000)
/lib64/ld-linux-x86-64.so.2 (0x00007f3a77ec4000)
```

### 进程的内存数据

当程序被系统函数execve加载到内存中时，操作系统会给它分配内存资源，并找到程序入口开始执行。主进程默认会启动一个主线程去执行main入口函数。

分配的内存资源主要用于存储程序指令和程序数据。还有额外的进程内存数据、进程标识、进程状态、哪个用户启动的、打开的文件等。

这些数据主要存储在系统的`/proc`目录中，`/proc`目录存储了操作系统上所有的进程的内存数据。进程对应的目录就用进程号命名，比如进程42对应的目录就是`/proc/42`。

- cmdline文件，记录进程是用什么命令启动的，僵尸进程这个文件是空的。
- environ文件，记录进程的环境参数。
- exe软连接，进程是哪个可执行文件启动的。
- fd目录，记录进程打开的文件目录。
- limits文件，记录进程的资源限制。
- net目录，记录进程和网络有关的数据，比如socket。
- stat文件，记录进程状态数据、线程数据、信号数据等。
- status文件，和stat文件一样，不过可读性更强。
